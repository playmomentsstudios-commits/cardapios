<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Alfa – Cardápio Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase JS v2 (só para AUTH no front) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg: #0b1220;
      --surface: rgba(255,255,255,.06);
      --card: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --brand: #5aa9ff;
      --brand2: #2f7dff;
      --danger: #ff5a7a;
      --ok: #37d67a;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(90,169,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(55,214,122,.18), transparent 60%),
                  var(--bg);
      color: var(--text);
    }

    .container{ max-width: 1180px; margin: 18px auto; padding: 0 14px 34px; }

    header{
      margin: 14px 0 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .header-top{
      display:flex; gap:14px; justify-content: space-between; align-items:center;
      flex-wrap:wrap;
    }

    .brandbox{ display:flex; gap:12px; align-items:center; min-width: 240px; }
    .logo-slot{
      width:46px; height:46px; border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.28);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      color: var(--muted); font-weight: 900; user-select:none;
    }

    .brandtext h1{ margin:0; font-size: 18px; letter-spacing: .2px; }
    .brandtext .sub{ margin-top: 2px; font-size: 12px; color: var(--muted); }

    .hdr-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius: 999px;
      border: 1px solid var(--border); background: rgba(255,255,255,.06);
      color: var(--text); font-size: 12px; white-space: nowrap;
    }
    .pill code{
      color: rgba(255,255,255,.85);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 850;
      transition: transform .08s ease, background .15s ease, border .15s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      border-color: rgba(255,255,255,.15);
      color: #06101f;
    }
    .btn.danger{
      background: rgba(255,90,122,.14);
      border-color: rgba(255,90,122,.35);
      color: rgba(255,255,255,.92);
    }
    .btn.small{ padding: 8px 10px; border-radius: 14px; font-size: 12px; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .summary{
      display:grid; grid-template-columns: repeat(3, 1fr);
      gap: 12px; margin-top: 14px;
    }
    @media (max-width: 860px){ .summary{ grid-template-columns: 1fr; } }

    .sumcard{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 12px 14px;
      display:flex; justify-content: space-between; align-items:center; gap:10px;
      min-height: 64px;
    }
    .sumcard .label{ color: var(--muted); font-size: 12px; }
    .sumcard .value{ font-size: 20px; font-weight: 950; }

    .panel{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .hidden{ display:none; }
    .muted{ color: var(--muted); font-size: 13px; }

    .tabs{ margin-top: 16px; display:flex; justify-content: center; }
    .seg{
      display:flex; gap:0;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      overflow:hidden;
      width: fit-content;
    }
    .seg button{
      border:0; background: transparent;
      color: var(--muted);
      padding: 10px 18px;
      cursor:pointer;
      font-weight: 950;
      transition: background .15s ease, color .15s ease;
      letter-spacing: .2px;
    }
    .seg button.active{ background: rgba(255,255,255,.12); color: var(--text); }
    .seg button:hover{ background: rgba(255,255,255,.09); color: var(--text); }

    .card{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 16px;
      margin-top: 14px;
    }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    @media (max-width: 900px){ .row,.row3{ grid-template-columns: 1fr; } }

    label{ font-size: 12px; color: var(--muted); display:block; margin: 4px 0 6px; }

    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
      transition: border .15s ease, background .15s ease;
    }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.45); }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(90,169,255,.55);
      background: rgba(0,0,0,.28);
    }
    textarea{ min-height: 96px; resize: vertical; }

    .form-actions{ display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; margin-top: 12px; }

    .table-wrap{
      margin-top: 12px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
    }
    table{ width:100%; border-collapse: collapse; min-width: 980px; }
    th, td{
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      vertical-align: top;
      font-size: 14px;
    }
    th{
      position: sticky; top: 0;
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.88);
      font-size: 12px;
      letter-spacing: .3px;
      text-transform: uppercase;
    }

    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: rgba(255,255,255,.86);
    }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: rgba(255,255,255,.88);
      white-space:nowrap;
    }
    .tag.ok{ border-color: rgba(55,214,122,.35); background: rgba(55,214,122,.10); }
    .tag.off{ border-color: rgba(255,90,122,.35); background: rgba(255,90,122,.10); }

    .switch{ position: relative; width: 46px; height: 26px; display:inline-block; }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0;
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.16);
      border-radius: 999px;
      transition: .2s;
      cursor:pointer;
    }
    .slider:before{
      content:"";
      position:absolute;
      width: 20px; height: 20px;
      left: 3px; top: 2px;
      border-radius: 999px;
      background: rgba(255,255,255,.85);
      transition:.2s;
    }
    .switch input:checked + .slider{
      background: rgba(55,214,122,.22);
      border-color: rgba(55,214,122,.28);
    }
    .switch input:checked + .slider:before{
      transform: translateX(20px);
      background: rgba(255,255,255,.92);
    }

    .msg{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      margin-top: 12px;
      background: rgba(255,255,255,.06);
    }
    .msg.ok{ border-color: rgba(55,214,122,.35); background: rgba(55,214,122,.10); }
    .msg.err{ border-color: rgba(255,90,122,.35); background: rgba(255,90,122,.10); }

    .modal-backdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 16px; z-index: 9999;
    }
    .modal{
      width: min(860px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,16,30,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 10px;
    }
    .modal-title{ font-weight: 950; letter-spacing: .2px; }
  </style>
</head>

<body>
  <div class="container">

    <header>
      <div class="header-top">
        <div class="brandbox">
          <div class="logo-slot" title="Espaço para logo">LOGO</div>
          <div class="brandtext">
            <h1>Painel Alfa – Cardápio Digital</h1>
            <div class="sub">Super Admin • CRUD seguro via Vercel (Service Role)</div>
          </div>
        </div>

        <div class="hdr-actions">
          <span class="pill"><b>Status:</b> <span id="statusUser">-</span></span>
          <span class="pill"><b>API:</b> <code id="apiHost">-</code></span>
          <button class="btn danger" id="btnLogout" type="button">Sair</button>
        </div>
      </div>

      <div class="summary">
        <div class="sumcard">
          <div><div class="label">Clientes</div><div class="value" id="countClientes">-</div></div>
          <span class="tag">Total</span>
        </div>
        <div class="sumcard">
          <div><div class="label">Categorias</div><div class="value" id="countCategorias">-</div></div>
          <span class="tag">Total</span>
        </div>
        <div class="sumcard">
          <div><div class="label">Produtos</div><div class="value" id="countProdutos">-</div></div>
          <span class="tag">Total</span>
        </div>
      </div>

      <div class="tabs">
        <div class="seg">
          <button class="active" data-tab="tabClientes" type="button">Clientes</button>
          <button data-tab="tabCategorias" type="button">Categorias</button>
          <button data-tab="tabProdutos" type="button">Produtos</button>
        </div>
      </div>
    </header>

    <!-- LOGIN -->
    <section id="secLogin" class="panel">
      <h2 style="margin:0 0 10px;">Login (Supabase Auth)</h2>
      <div class="row">
        <div>
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="seuemail@dominio.com" autocomplete="email" />
        </div>
        <div>
          <label>Senha</label>
          <input type="password" id="loginSenha" placeholder="••••••••" autocomplete="current-password" />
        </div>
      </div>

      <div class="form-actions">
        <button class="btn primary" id="btnLogin" type="button">Entrar</button>
      </div>

      <div id="loginMsg"></div>
      <p class="muted">Depois de logar, o CRUD roda via Vercel com token (Bearer).</p>
    </section>

    <!-- ADMIN -->
    <section id="secAdmin" class="panel hidden">
      <div id="globalMsg"></div>

      <!-- CLIENTES -->
      <section id="tabClientes">
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
            <div>
              <h2 style="margin:0;">Cadastrar Cliente</h2>
              <div class="muted">Crie a loja e gere o link publicado.</div>
            </div>
            <div class="tag">Aba Clientes</div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div>
              <label>Nome do negócio</label>
              <input id="cliNome" placeholder="ex: Cafeteria do João" />
            </div>
            <div>
              <label>Slug</label>
              <input id="cliSlug" placeholder="ex: cafeteria-do-joao" />
            </div>
          </div>

          <div class="row" style="margin-top:8px;">
            <div>
              <label>WhatsApp</label>
              <input id="cliWhats" placeholder="ex: 5599999999999" />
            </div>
            <div>
              <label>Status do cliente</label>
              <select id="cliAtivo">
                <option value="true">Ativo</option>
                <option value="false">Inativo</option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn primary" id="btnSalvarCliente" type="button">Salvar Cliente</button>
          </div>
          <div id="msgCliente"></div>
          <div class="muted" style="margin-top:8px;">Link público: <code>?u=slug</code> (ex: <code>?u=cafeteria-do-joao</code>).</div>
        </div>

        <div class="card">
          <div class="row" style="align-items:end;">
            <div>
              <h2 style="margin:0;">Clientes cadastrados</h2>
              <div class="muted">Ações: ver publicado, ativar/desativar, editar, duplicar ou excluir.</div>
            </div>
            <div>
              <label>Buscar</label>
              <input id="filtroCliente" placeholder="Buscar por nome/slug..." />
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Slug</th>
                  <th>WhatsApp</th>
                  <th>Status</th>
                  <th>Ativar</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="tbClientes"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CATEGORIAS -->
      <section id="tabCategorias" class="hidden">
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
            <div>
              <h2 style="margin:0;">Cadastrar Categoria</h2>
              <div class="muted">Organize o cardápio em seções.</div>
            </div>
            <div class="tag">Aba Categorias</div>
          </div>

          <div class="row3" style="margin-top:12px;">
            <div>
              <label>Cliente</label>
              <select id="catCliente"></select>
            </div>
            <div>
              <label>Nome da categoria</label>
              <input id="catNome" placeholder="ex: Cuscuz, Bebidas, Doces" />
            </div>
            <div>
              <label>Ordem</label>
              <input id="catOrdem" type="number" placeholder="ex: 1" />
            </div>
          </div>

          <div class="row" style="margin-top:8px;">
            <div>
              <label>Status</label>
              <select id="catAtivo">
                <option value="true">Ativa</option>
                <option value="false">Inativa</option>
              </select>
            </div>
            <div class="form-actions" style="justify-content:flex-end; align-items:end; margin-top:0;">
              <button class="btn primary" id="btnSalvarCategoria" type="button">Salvar Categoria</button>
            </div>
          </div>

          <div id="msgCategoria"></div>
        </div>

        <div class="card">
          <div class="row3" style="align-items:end;">
            <div>
              <h2 style="margin:0;">Categorias cadastradas</h2>
              <div class="muted">Filtre por cliente, edite/duplique/exclua.</div>
            </div>
            <div>
              <label>Filtro por cliente</label>
              <select id="filtroCatCliente"></select>
            </div>
            <div>
              <label>Buscar</label>
              <input id="filtroCategoria" placeholder="Buscar por nome..." />
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Nome</th>
                  <th>Ordem</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="tbCategorias"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PRODUTOS -->
      <section id="tabProdutos" class="hidden">
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
            <div>
              <h2 style="margin:0;">Cadastrar Produto</h2>
              <div class="muted">Produto com preço, imagem e descrição.</div>
            </div>
            <div class="tag">Aba Produtos</div>
          </div>

          <div class="row3" style="margin-top:12px;">
            <div>
              <label>Cliente</label>
              <select id="prodCliente"></select>
            </div>
            <div>
              <label>Categoria</label>
              <select id="prodCategoria"></select>
            </div>
            <div>
              <label>Nome do produto</label>
              <input id="prodNome" placeholder="ex: Cuscuz da Baiana" />
            </div>
          </div>

          <div class="row3" style="margin-top:8px;">
            <div>
              <label>Preço</label>
              <input id="prodPreco" type="number" step="0.01" placeholder="ex: 12.50" />
            </div>
            <div>
              <label>Imagem (URL)</label>
              <input id="prodImg" placeholder="opcional" />
            </div>
            <div>
              <label>Status</label>
              <select id="prodAtivo">
                <option value="true">Ativo</option>
                <option value="false">Inativo</option>
              </select>
            </div>
          </div>

          <div style="margin-top:8px;">
            <label>Descrição</label>
            <textarea id="prodDesc" placeholder="opcional"></textarea>
          </div>

          <div class="form-actions">
            <button class="btn primary" id="btnSalvarProduto" type="button">Salvar Produto</button>
          </div>

          <div id="msgProduto"></div>
        </div>

        <div class="card">
          <div class="row3" style="align-items:end;">
            <div>
              <h2 style="margin:0;">Produtos cadastrados</h2>
              <div class="muted">Filtre por cliente, edite/duplique/exclua.</div>
            </div>
            <div>
              <label>Filtro por cliente</label>
              <select id="filtroProdCliente"></select>
            </div>
            <div>
              <label>Buscar</label>
              <input id="filtroProduto" placeholder="Buscar por nome..." />
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Categoria</th>
                  <th>Produto</th>
                  <th>Preço</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="tbProdutos"></tbody>
            </table>
          </div>
        </div>
      </section>
    </section>

  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Editar</div>
        <button class="btn small" id="modalClose" type="button">Fechar</button>
      </div>
      <div id="modalBody"></div>
      <div class="form-actions" style="margin-top:12px;">
        <button class="btn small" id="modalCancel" type="button">Cancelar</button>
        <button class="btn primary small" id="modalSave" type="button">Salvar</button>
      </div>
      <div id="modalMsg"></div>
    </div>
  </div>

<script>
  console.log("ADMIN (VERCEL) JS CARREGOU ✅");

  // ======================================
  // CONFIG (AUTH no Supabase + CRUD na Vercel)
  // ======================================
  const SUPABASE_URL = "https://rgsnmxspyywwouhcdwkj.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_nHPsCV3y79FgexEMAeANWQ_P6jWRDd1";

  // Base da API (Vercel)
  // - Se você abrir este admin no domínio da Vercel, ele usa location.origin
  // - Se abrir no GitHub Pages, ele usa seu domínio fixo da Vercel
  const VERCEL_BASE = "https://cafeteria-gamma-orpin.vercel.app";
  const API_BASE = (location.hostname.endsWith("vercel.app")) ? location.origin : VERCEL_BASE;

  document.getElementById("apiHost").textContent = new URL(API_BASE).host;

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false }
  });

  const $ = (id) => document.getElementById(id);

  function showMsg(el, type, text){
    if(!el) return;
    el.innerHTML = `<div class="msg ${type}">${text}</div>`;
  }
  function clearMsg(el){ if(el) el.innerHTML = ""; }

  function setBtnLoading(btn, loading, text){
    if(!btn) return;
    if(loading){
      btn.disabled = true;
      btn.dataset._old = btn.textContent;
      btn.textContent = text || "Salvando...";
    } else {
      btn.disabled = false;
      btn.textContent = btn.dataset._old || btn.textContent;
      delete btn.dataset._old;
    }
  }

  function slugify(str){
    return String(str || "")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "");
  }
  function brl(v){
    return Number(v || 0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  }
  function tagAtivo(v){
    return v ? `<span class="tag ok">Ativo</span>` : `<span class="tag off">Inativo</span>`;
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

  function publicBaseUrl(){
    const url = new URL(location.href);
    url.pathname = url.pathname.replace(/\/admin\/?$/, "/");
    url.search = "";
    url.hash = "";
    return url.toString();
  }
  function openPublished(slug){
    const base = publicBaseUrl();
    window.open(`${base}?u=${encodeURIComponent(slug)}`, "_blank");
  }
  window.openPublished = openPublished;

  // ======================================
  // API helper (com Bearer token)
  // ======================================
  async function getToken(){
    const { data } = await supabaseClient.auth.getSession();
    const token = data?.session?.access_token;
    if(!token) throw new Error("Sem sessão. Faça login novamente.");
    return token;
  }

  async function apiFetch(path, { method="GET", body } = {}){
    const token = await getToken();

    const res = await fetch(`${API_BASE}${path}`, {
      method,
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: body ? JSON.stringify(body) : undefined
    });

    const json = await res.json().catch(() => ({}));

    if(!res.ok){
      const msg = json?.error || `Erro HTTP ${res.status}`;
      throw new Error(msg);
    }
    return json;
  }

  // ======================================
  // STATE
  // ======================================
  let CLIENTES = [];
  let CATEGORIAS = [];
  let PRODUTOS = [];

  // ======================================
  // AUTH
  // ======================================
  async function login(){
    clearMsg($("loginMsg"));
    const email = $("loginEmail").value.trim();
    const password = $("loginSenha").value;
    if(!email || !password){
      showMsg($("loginMsg"), "err", "Preencha email e senha.");
      return;
    }
    const btn = $("btnLogin");
    setBtnLoading(btn, true, "Entrando...");
    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
    setBtnLoading(btn, false);
    if(error) showMsg($("loginMsg"), "err", error.message || "Erro no login");
  }

  async function logout(){
    await supabaseClient.auth.signOut();
    location.reload();
  }

  $("btnLogin").addEventListener("click", login);
  $("btnLogout").addEventListener("click", logout);

  supabaseClient.auth.onAuthStateChange(async (_, session) => {
    if(session){
      $("secLogin").classList.add("hidden");
      $("secAdmin").classList.remove("hidden");
      $("statusUser").textContent = session.user.email;
      await refreshAll();
    }else{
      $("secAdmin").classList.add("hidden");
      $("secLogin").classList.remove("hidden");
    }
  });

  // Tabs
  document.querySelectorAll(".seg button").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".seg button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      ["tabClientes","tabCategorias","tabProdutos"].forEach(id => $(id).classList.add("hidden"));
      $(tab).classList.remove("hidden");
    });
  });

  async function refreshAll(){
    clearMsg($("globalMsg"));
    try{
      await Promise.all([loadClientes(true), loadCategorias(true), loadProdutos(true)]);
      await loadCategoriasSelectProduto();
    }catch(err){
      console.error(err);
      showMsg($("globalMsg"), "err", err.message || String(err));
    }
  }

  // ======================================
  // LOAD (via Vercel)
  // ======================================
  async function loadClientes(){
    const { data } = await apiFetch("/api/admin/clientes", { method:"GET" });
    CLIENTES = data || [];
    $("countClientes").textContent = CLIENTES.length;

    // popular selects
    const optBase = `<option value="">Selecione o cliente</option>`;
    const opts = CLIENTES.map(c => `<option value="${escapeAttr(c.slug)}">${escapeHtml(c.nome)} (${escapeHtml(c.slug)})</option>`).join("");

    $("catCliente").innerHTML = optBase + opts;
    $("prodCliente").innerHTML = optBase + opts;
    $("filtroCatCliente").innerHTML = `<option value="">Todos os clientes</option>` + opts;
    $("filtroProdCliente").innerHTML = `<option value="">Todos os clientes</option>` + opts;

    renderClientes();
  }

  async function loadCategorias(){
    const { data } = await apiFetch("/api/admin/categorias", { method:"GET" });
    CATEGORIAS = data || [];
    $("countCategorias").textContent = CATEGORIAS.length;
    renderCategorias();
  }

  async function loadProdutos(){
    const { data } = await apiFetch("/api/admin/produtos", { method:"GET" });
    PRODUTOS = data || [];
    $("countProdutos").textContent = PRODUTOS.length;
    renderProdutos();
  }

  // ======================================
  // CLIENTES
  // ======================================
  $("cliNome").addEventListener("input", () => {
    if(!$("cliSlug").value.trim()) $("cliSlug").value = slugify($("cliNome").value);
  });

  $("filtroCliente").addEventListener("input", renderClientes);
  $("btnSalvarCliente").addEventListener("click", salvarCliente);

  async function salvarCliente(){
    clearMsg($("msgCliente"));
    const nome = $("cliNome").value.trim();
    const slug = slugify($("cliSlug").value.trim());
    const whatsapp = $("cliWhats").value.trim();
    const ativo = $("cliAtivo").value === "true";

    if(!nome || !slug || !whatsapp){
      showMsg($("msgCliente"), "err", "Preencha nome, slug e WhatsApp.");
      return;
    }

    const btn = $("btnSalvarCliente");
    setBtnLoading(btn, true);

    try{
      await apiFetch("/api/admin/clientes", {
        method: "POST",
        body: { nome, slug, whatsapp, ativo }
      });

      showMsg($("msgCliente"), "ok", "Cliente criado!");
      $("cliNome").value=""; $("cliSlug").value=""; $("cliWhats").value="";
      $("cliAtivo").value="true";
      await refreshAll();
    }catch(err){
      console.error(err);
      showMsg($("msgCliente"), "err", err.message || String(err));
    }finally{
      setBtnLoading(btn, false);
    }
  }

  function renderClientes(){
    const q = ($("filtroCliente").value || "").trim().toLowerCase();
    const rows = CLIENTES
      .filter(c => !q || (c.nome||"").toLowerCase().includes(q) || (c.slug||"").toLowerCase().includes(q))
      .map(c => {
        const isAtivo = (c.ativo === undefined) ? true : !!c.ativo;
        return `
          <tr>
            <td><b>${escapeHtml(c.nome)}</b></td>
            <td><code>${escapeHtml(c.slug)}</code></td>
            <td>${escapeHtml(c.whatsapp||"")}</td>
            <td>${tagAtivo(isAtivo)}</td>
            <td>
              <label class="switch" title="Ativar/Desativar">
                <input type="checkbox" ${isAtivo ? "checked":""}
                  onchange="toggleClienteAtivo('${escapeAttr(c.slug)}', this.checked)">
                <span class="slider"></span>
              </label>
            </td>
            <td>
              <div class="actions">
                <button class="btn small" type="button" onclick="openPublished('${escapeAttr(c.slug)}')">Ver publicado</button>
                <button class="btn primary small" type="button" onclick="openEditCliente('${escapeAttr(c.slug)}')">Editar</button>
                <button class="btn small" type="button" onclick="duplicateCliente('${escapeAttr(c.slug)}')">Duplicar</button>
                <button class="btn danger small" type="button" onclick="deleteCliente('${escapeAttr(c.slug)}')">Excluir</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

    $("tbClientes").innerHTML = rows || `<tr><td colspan="6" class="muted">Nenhum cliente.</td></tr>`;
  }

  window.toggleClienteAtivo = async (slug, ativo) => {
    try{
      await apiFetch("/api/admin/clientes", { method:"PATCH", body: { slug, ativo } });
      CLIENTES = CLIENTES.map(c => c.slug === slug ? ({...c, ativo}) : c);
      renderClientes();
    }catch(err){
      console.error(err);
      showMsg($("globalMsg"), "err", "Falha ao atualizar status: " + (err.message || String(err)));
      await loadClientes();
    }
  };

  // ======================================
  // MODAL infra
  // ======================================
  let MODAL_CTX = null;

  $("modalClose").addEventListener("click", closeModal);
  $("modalCancel").addEventListener("click", closeModal);
  $("modalBackdrop").addEventListener("click", (e) => { if(e.target.id==="modalBackdrop") closeModal(); });

  function openModal(title, bodyHtml, onSave){
    MODAL_CTX = { onSave };
    $("modalTitle").textContent = title;
    $("modalBody").innerHTML = bodyHtml;
    $("modalMsg").innerHTML = "";
    $("modalBackdrop").style.display = "flex";
    $("modalSave").onclick = async () => {
      $("modalMsg").innerHTML = "";
      try{ await MODAL_CTX.onSave(); }
      catch(err){ showMsg($("modalMsg"), "err", err.message || String(err)); }
    };
  }
  function closeModal(){
    $("modalBackdrop").style.display = "none";
    MODAL_CTX = null;
  }

  window.openEditCliente = (slug) => {
    const c = CLIENTES.find(x => x.slug === slug);
    if(!c) return;
    const ativoAtual = (c.ativo === undefined) ? true : !!c.ativo;

    openModal(
      `Editar Cliente (${c.slug})`,
      `
        <div class="row">
          <div>
            <label>Nome</label>
            <input id="m_cliNome" value="${escapeAttr(c.nome)}" />
          </div>
          <div>
            <label>WhatsApp</label>
            <input id="m_cliWhats" value="${escapeAttr(c.whatsapp || "")}" />
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div>
            <label>Status</label>
            <select id="m_cliAtivo">
              <option value="true" ${ativoAtual ? "selected":""}>Ativo</option>
              <option value="false" ${!ativoAtual ? "selected":""}>Inativo</option>
            </select>
          </div>
          <div class="muted" style="display:flex; align-items:end;">
            Obs: o slug não é editado aqui (evita quebrar links). Se quiser, eu habilito depois com migração.
          </div>
        </div>
      `,
      async () => {
        const nome = $("m_cliNome").value.trim();
        const whatsapp = $("m_cliWhats").value.trim();
        const ativo = $("m_cliAtivo").value === "true";
        if(!nome || !whatsapp) throw new Error("Preencha nome e WhatsApp.");

        await apiFetch("/api/admin/clientes", { method:"PATCH", body: { slug, nome, whatsapp, ativo } });
        showMsg($("modalMsg"), "ok", "Cliente atualizado!");
        await refreshAll();
      }
    );
  };

  window.duplicateCliente = async (slug) => {
    const c = CLIENTES.find(x => x.slug === slug);
    if(!c) return;

    let base = slugify(c.slug + "-copia");
    let trySlug = base;
    let i = 2;
    while(CLIENTES.some(x => x.slug === trySlug)) trySlug = `${base}-${i++}`;

    if(!confirm(`Duplicar cliente "${c.nome}" para slug "${trySlug}"?`)) return;

    try{
      await apiFetch("/api/admin/clientes", {
        method:"POST",
        body: { nome: c.nome + " (cópia)", slug: trySlug, whatsapp: c.whatsapp, ativo: !!c.ativo }
      });
      await refreshAll();
    }catch(err){
      alert(err.message || String(err));
    }
  };

  window.deleteCliente = async (slug) => {
    const c = CLIENTES.find(x => x.slug === slug);
    if(!c) return;

    if(!confirm(`Excluir cliente "${c.nome}"?\n\nIsso vai apagar categorias e produtos ligados a ele.`)) return;

    try{
      await apiFetch("/api/admin/clientes", { method:"DELETE", body:{ slug } });
      await refreshAll();
    }catch(err){
      alert(err.message || String(err));
    }
  };

  // ======================================
  // CATEGORIAS
  // ======================================
  $("btnSalvarCategoria").addEventListener("click", salvarCategoria);
  $("filtroCatCliente").addEventListener("change", renderCategorias);
  $("filtroCategoria").addEventListener("input", renderCategorias);

  async function salvarCategoria(){
    clearMsg($("msgCategoria"));
    const cliente_slug = $("catCliente").value;
    const nome = $("catNome").value.trim();
    const ordem = Number($("catOrdem").value || 0);
    const ativo = $("catAtivo").value === "true";

    if(!cliente_slug || !nome){
      showMsg($("msgCategoria"), "err", "Selecione o cliente e informe o nome.");
      return;
    }

    const btn = $("btnSalvarCategoria");
    setBtnLoading(btn, true);

    try{
      await apiFetch("/api/admin/categorias", { method:"POST", body:{ cliente_slug, nome, ordem, ativo } });
      showMsg($("msgCategoria"), "ok", "Categoria criada!");
      $("catNome").value=""; $("catOrdem").value=""; $("catAtivo").value="true";
      await refreshAll();
    }catch(err){
      console.error(err);
      showMsg($("msgCategoria"), "err", err.message || String(err));
    }finally{
      setBtnLoading(btn, false);
    }
  }

  function renderCategorias(){
    const cliente = $("filtroCatCliente").value;
    const q = ($("filtroCategoria").value || "").trim().toLowerCase();

    const rows = CATEGORIAS
      .filter(c => (!cliente || c.cliente_slug === cliente))
      .filter(c => (!q || (c.nome||"").toLowerCase().includes(q)))
      .map(c => `
        <tr>
          <td>${escapeHtml(c.cliente_slug)}</td>
          <td><b>${escapeHtml(c.nome)}</b></td>
          <td>${Number(c.ordem||0)}</td>
          <td>${tagAtivo(!!c.ativo)}</td>
          <td>
            <div class="actions">
              <button class="btn primary small" type="button" onclick="openEditCategoria(${c.id})">Editar</button>
              <button class="btn small" type="button" onclick="duplicateCategoria(${c.id})">Duplicar</button>
              <button class="btn danger small" type="button" onclick="deleteCategoria(${c.id})">Excluir</button>
            </div>
          </td>
        </tr>
      `).join("");

    $("tbCategorias").innerHTML = rows || `<tr><td colspan="5" class="muted">Nenhuma categoria.</td></tr>`;
  }

  window.openEditCategoria = (id) => {
    const c = CATEGORIAS.find(x => Number(x.id) === Number(id));
    if(!c) return;

    openModal(
      `Editar Categoria (#${c.id})`,
      `
        <div class="row">
          <div>
            <label>Cliente (slug)</label>
            <input id="m_catCliente" value="${escapeAttr(c.cliente_slug)}" />
          </div>
          <div>
            <label>Nome</label>
            <input id="m_catNome" value="${escapeAttr(c.nome)}" />
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div>
            <label>Ordem</label>
            <input id="m_catOrdem" type="number" value="${Number(c.ordem||0)}" />
          </div>
          <div>
            <label>Status</label>
            <select id="m_catAtivo">
              <option value="true" ${c.ativo ? "selected":""}>Ativa</option>
              <option value="false" ${!c.ativo ? "selected":""}>Inativa</option>
            </select>
          </div>
        </div>
      `,
      async () => {
        const cliente_slug = $("m_catCliente").value.trim();
        const nome = $("m_catNome").value.trim();
        const ordem = Number($("m_catOrdem").value||0);
        const ativo = $("m_catAtivo").value === "true";
        if(!cliente_slug || !nome) throw new Error("Preencha cliente e nome.");

        await apiFetch("/api/admin/categorias", { method:"PATCH", body:{ id: c.id, cliente_slug, nome, ordem, ativo } });
        showMsg($("modalMsg"), "ok", "Categoria atualizada!");
        await refreshAll();
      }
    );
  };

  window.duplicateCategoria = async (id) => {
    const c = CATEGORIAS.find(x => Number(x.id) === Number(id));
    if(!c) return;
    if(!confirm(`Duplicar categoria "${c.nome}"?`)) return;

    try{
      await apiFetch("/api/admin/categorias", {
        method:"POST",
        body:{ cliente_slug: c.cliente_slug, nome: c.nome + " (cópia)", ordem: Number(c.ordem||0) + 1, ativo: !!c.ativo }
      });
      await refreshAll();
    }catch(err){ alert(err.message || String(err)); }
  };

  window.deleteCategoria = async (id) => {
    const c = CATEGORIAS.find(x => Number(x.id) === Number(id));
    if(!c) return;
    if(!confirm(`Excluir categoria "${c.nome}"? (produtos ligados serão removidos)`)) return;

    try{
      await apiFetch("/api/admin/categorias", { method:"DELETE", body:{ id: c.id } });
      await refreshAll();
    }catch(err){ alert(err.message || String(err)); }
  };

  // ======================================
  // PRODUTOS
  // ======================================
  $("prodCliente").addEventListener("change", loadCategoriasSelectProduto);
  $("btnSalvarProduto").addEventListener("click", salvarProduto);
  $("filtroProdCliente").addEventListener("change", renderProdutos);
  $("filtroProduto").addEventListener("input", renderProdutos);

  async function loadCategoriasSelectProduto(){
    const slug = $("prodCliente").value;
    $("prodCategoria").innerHTML = `<option value="">Selecione a categoria</option>`;
    if(!slug) return;

    const cats = CATEGORIAS.filter(c => c.cliente_slug === slug).sort((a,b)=>(a.ordem||0)-(b.ordem||0));
    const opts = cats.map(c => `<option value="${c.id}">${escapeHtml(c.nome)}</option>`).join("");
    $("prodCategoria").innerHTML = `<option value="">Selecione a categoria</option>` + opts;
  }

  async function salvarProduto(){
    clearMsg($("msgProduto"));

    const cliente_slug = $("prodCliente").value;
    const categoria_id = $("prodCategoria").value;
    const nome = $("prodNome").value.trim();
    const preco = Number($("prodPreco").value || 0);
    const imagem = $("prodImg").value.trim() || null;
    const ativo = $("prodAtivo").value === "true";
    const descricao = $("prodDesc").value.trim();

    if(!cliente_slug || !categoria_id || !nome || !preco){
      showMsg($("msgProduto"), "err", "Preencha cliente, categoria, nome e preço.");
      return;
    }

    const btn = $("btnSalvarProduto");
    setBtnLoading(btn, true);

    try{
      await apiFetch("/api/admin/produtos", {
        method:"POST",
        body:{
          cliente_slug,
          categoria_id: Number(categoria_id),
          nome,
          descricao,
          preco,
          imagem,
          ativo,
          ordem: 0
        }
      });

      showMsg($("msgProduto"), "ok", "Produto criado!");
      $("prodNome").value=""; $("prodPreco").value=""; $("prodImg").value=""; $("prodAtivo").value="true"; $("prodDesc").value="";
      await refreshAll();
    }catch(err){
      console.error(err);
      showMsg($("msgProduto"), "err", err.message || String(err));
    }finally{
      setBtnLoading(btn, false);
    }
  }

  function nomeCategoriaById(id){
    const c = CATEGORIAS.find(x => String(x.id) === String(id));
    return c ? c.nome : "-";
  }

  function renderProdutos(){
    const cliente = $("filtroProdCliente").value;
    const q = ($("filtroProduto").value || "").trim().toLowerCase();

    const rows = PRODUTOS
      .filter(p => (!cliente || p.cliente_slug === cliente))
      .filter(p => (!q || (p.nome||"").toLowerCase().includes(q)))
      .map(p => `
        <tr>
          <td>${escapeHtml(p.cliente_slug)}</td>
          <td>${escapeHtml(nomeCategoriaById(p.categoria_id))} <span class="muted">(#${p.categoria_id})</span></td>
          <td>
            <b>${escapeHtml(p.nome)}</b>
            <div class="muted">${escapeHtml((p.descricao||"").slice(0,80))}${(p.descricao||"").length>80?"…":""}</div>
          </td>
          <td>${brl(p.preco)}</td>
          <td>${tagAtivo(!!p.ativo)}</td>
          <td>
            <div class="actions">
              <button class="btn primary small" type="button" onclick="openEditProduto(${p.id})">Editar</button>
              <button class="btn small" type="button" onclick="duplicateProduto(${p.id})">Duplicar</button>
              <button class="btn danger small" type="button" onclick="deleteProduto(${p.id})">Excluir</button>
            </div>
          </td>
        </tr>
      `).join("");

    $("tbProdutos").innerHTML = rows || `<tr><td colspan="6" class="muted">Nenhum produto.</td></tr>`;
  }

  window.openEditProduto = (id) => {
    const p = PRODUTOS.find(x => Number(x.id) === Number(id));
    if(!p) return;

    const cats = CATEGORIAS
      .filter(c => c.cliente_slug === p.cliente_slug)
      .sort((a,b)=>(a.ordem||0)-(b.ordem||0));

    const catOpts = cats.map(c => `<option value="${c.id}" ${Number(c.id)===Number(p.categoria_id)?"selected":""}>${escapeHtml(c.nome)}</option>`).join("");

    openModal(
      `Editar Produto (#${p.id})`,
      `
        <div class="row3">
          <div>
            <label>Cliente (slug)</label>
            <input id="m_prodCliente" value="${escapeAttr(p.cliente_slug)}" />
          </div>
          <div>
            <label>Categoria</label>
            <select id="m_prodCategoria">${catOpts || `<option value="${p.categoria_id}">#${p.categoria_id}</option>`}</select>
          </div>
          <div>
            <label>Status</label>
            <select id="m_prodAtivo">
              <option value="true" ${p.ativo ? "selected":""}>Ativo</option>
              <option value="false" ${!p.ativo ? "selected":""}>Inativo</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div>
            <label>Nome</label>
            <input id="m_prodNome" value="${escapeAttr(p.nome)}" />
          </div>
          <div>
            <label>Preço</label>
            <input id="m_prodPreco" type="number" step="0.01" value="${Number(p.preco||0)}" />
          </div>
        </div>

        <div style="margin-top:8px;">
          <label>Imagem (URL)</label>
          <input id="m_prodImg" value="${escapeAttr(p.imagem || "")}" />
        </div>

        <div style="margin-top:8px;">
          <label>Descrição</label>
          <textarea id="m_prodDesc">${escapeHtml(p.descricao || "")}</textarea>
        </div>
      `,
      async () => {
        const cliente_slug = $("m_prodCliente").value.trim();
        const categoria_id = Number($("m_prodCategoria").value);
        const ativo = $("m_prodAtivo").value === "true";
        const nome = $("m_prodNome").value.trim();
        const preco = Number($("m_prodPreco").value||0);
        const imagem = $("m_prodImg").value.trim() || null;
        const descricao = $("m_prodDesc").value.trim();

        if(!cliente_slug || !categoria_id || !nome || !preco) throw new Error("Preencha cliente, categoria, nome e preço.");

        await apiFetch("/api/admin/produtos", {
          method:"PATCH",
          body:{ id: p.id, cliente_slug, categoria_id, ativo, nome, preco, imagem, descricao }
        });

        showMsg($("modalMsg"), "ok", "Produto atualizado!");
        await refreshAll();
      }
    );
  };

  window.duplicateProduto = async (id) => {
    const p = PRODUTOS.find(x => Number(x.id) === Number(id));
    if(!p) return;
    if(!confirm(`Duplicar produto "${p.nome}"?`)) return;

    try{
      await apiFetch("/api/admin/produtos", {
        method:"POST",
        body:{
          cliente_slug: p.cliente_slug,
          categoria_id: p.categoria_id,
          nome: p.nome + " (cópia)",
          descricao: p.descricao || "",
          preco: Number(p.preco || 0),
          imagem: p.imagem || null,
          ativo: !!p.ativo,
          ordem: Number(p.ordem || 0) + 1
        }
      });
      await refreshAll();
    }catch(err){ alert(err.message || String(err)); }
  };

  window.deleteProduto = async (id) => {
    const p = PRODUTOS.find(x => Number(x.id) === Number(id));
    if(!p) return;
    if(!confirm(`Excluir produto "${p.nome}"?`)) return;

    try{
      await apiFetch("/api/admin/produtos", { method:"DELETE", body:{ id: p.id } });
      await refreshAll();
    }catch(err){ alert(err.message || String(err)); }
  };

  // Auto session
  (async () => {
    const { data } = await supabaseClient.auth.getSession();
    if(data?.session){
      $("secLogin").classList.add("hidden");
      $("secAdmin").classList.remove("hidden");
      $("statusUser").textContent = data.session.user.email;
      await refreshAll();
    }
  })();
</script>

</body>
</html>
