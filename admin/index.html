<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Alfa ‚Ä¢ Card√°pio Digital</title>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#050b14;
      --bg1:#071427;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --blue:#2f7cf7;
      --blue2:#1b4fd8;
      --teal:#19c3c3;
      --ok:#24c08a;
      --warn:#ffb020;
      --bad:#ff5d5d;
      --shadow:0 18px 60px rgba(0,0,0,.42);
      --radius:18px;
      --radius2:14px;
      --pad:16px;
      --pad2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(47,124,247,.35), transparent 60%),
        radial-gradient(900px 500px at 80% 30%, rgba(25,195,195,.20), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    a{color:inherit}
    .wrap{max-width:1120px;margin:0 auto;padding:26px 16px 36px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      gap:12px;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:220px}
    .logo{
      width:46px;height:46px;border-radius:14px;
      background:linear-gradient(135deg, rgba(47,124,247,.9), rgba(25,195,195,.65));
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      font-weight:800;
      letter-spacing:.6px;
    }
    .brand h1{font-size:16px;margin:0;line-height:1.1}
    .brand p{margin:2px 0 0;color:var(--muted2);font-size:12px}

    .pillrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:flex;gap:8px;align-items:center;
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill b{color:var(--text);font-weight:700}
    .btn{
      border:1px solid var(--stroke2);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;
      transition:.15s transform,.15s opacity,.15s background;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.08)}
    .btn:active{transform:translateY(0px);opacity:.9}
    .btn.primary{
      background:linear-gradient(135deg, rgba(47,124,247,.95), rgba(27,79,216,.90));
      border-color:rgba(255,255,255,.14);
    }
    .btn.danger{
      background:rgba(255,93,93,.14);
      border-color:rgba(255,93,93,.28);
      color:#ffdede;
    }
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:12px}
    .icon{width:16px;height:16px;display:inline-block;vertical-align:middle}

    .grid3{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      margin-top:16px;
    }
    .kpi{
      padding:14px 16px;border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
    }
    .kpi .t{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px}
    .kpi .v{font-size:22px;font-weight:800;margin-top:8px}
    .kpi .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.05);color:var(--muted)}
    .kpi.blue .v{color:#dfeaff}
    .kpi.teal .v{color:#d7fffb}
    .kpi.purple .v{color:#efe7ff}

    .panel{
      margin-top:16px;
      padding:16px;border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.035));
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow:0 30px 90px rgba(0,0,0,.35);
    }

    .tabs{
      display:flex;gap:10px;justify-content:center;align-items:center;
      padding:10px;border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      width:fit-content;margin:0 auto 14px;
    }
    .tab{
      padding:10px 14px;border-radius:999px;
      cursor:pointer;color:var(--muted);
      border:1px solid transparent;
      background:transparent;
      font-weight:700;font-size:13px;
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(255,255,255,.12);
      background:rgba(255,255,255,.07);
    }

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{
      flex:1;
      min-width:220px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{
      background:rgba(0,0,0,.18);
      border:1px solid var(--stroke);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color:rgba(47,124,247,.55);
      box-shadow:0 0 0 3px rgba(47,124,247,.18);
    }
    textarea{min-height:90px;resize:vertical}

    .split{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }

    .listhead{
      margin-top:14px;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;
    }

    .table{
      margin-top:10px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
    }
    .tr{
      display:grid;
      grid-template-columns: 1.1fr .9fr .9fr .6fr 64px;
      gap:10px;
      padding:12px 12px;
      align-items:center;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .tr:first-child{border-top:none}
    .th{
      color:rgba(255,255,255,.62);
      font-size:12px;
      background:rgba(255,255,255,.04);
      font-weight:800;
    }
    .td{font-size:13px;color:rgba(255,255,255,.88)}
    .td.muted{color:var(--muted2);font-size:12px}
    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      font-size:12px;font-weight:800;
      width:fit-content;
      background:rgba(255,255,255,.05);
      color:var(--muted);
    }
    .badge.ok{border-color:rgba(36,192,138,.35);background:rgba(36,192,138,.12);color:#c8ffe9}
    .badge.off{border-color:rgba(255,176,32,.35);background:rgba(255,176,32,.12);color:#fff1cc}

    .menuWrap{position:relative;display:flex;justify-content:flex-end}
    .dots{
      width:40px;height:36px;border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      cursor:pointer;
      display:grid;place-items:center;
    }
    .dots:hover{background:rgba(255,255,255,.08)}
    .menu{
      position:absolute;right:0;top:44px;
      min-width:190px;
      background:rgba(10,16,28,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      z-index:10;
    }
    .menu.open{display:block}
    .mi{
      padding:11px 12px;
      display:flex;gap:10px;align-items:center;
      cursor:pointer;
      color:rgba(255,255,255,.90);
      border-top:1px solid rgba(255,255,255,.06);
      font-size:13px;
      user-select:none;
    }
    .mi:first-child{border-top:none}
    .mi:hover{background:rgba(255,255,255,.06)}
    .mi.danger{color:#ffd0d0}
    .mi .s{color:rgba(255,255,255,.55);font-size:12px;margin-left:auto}

    .msg{
      margin-top:12px;
      padding:12px 14px;border-radius:16px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:13px;
    }
    .msg.bad{border-color:rgba(255,93,93,.35);background:rgba(255,93,93,.12);color:#ffdede}
    .msg.ok{border-color:rgba(36,192,138,.35);background:rgba(36,192,138,.12);color:#dbffee}

    /* LOGIN (estilo iFood) */
    .loginShell{
      max-width:980px;margin:24px auto 0;
      display:grid;grid-template-columns: 1fr 1fr;
      gap:16px;
      align-items:stretch;
    }
    .loginCard{
      border-radius:26px;
      padding:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.035));
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow:var(--shadow);
    }
    .loginBox{
      display:flex;flex-direction:column;gap:12px;
      padding:18px;
      border-radius:22px;
      background:rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.08);
      min-height:340px;
      justify-content:center;
    }
    .loginTitle{font-size:22px;margin:0}
    .loginSub{margin:2px 0 0;color:var(--muted2);font-size:13px}
    .stepTag{
      width:fit-content;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:rgba(255,255,255,.78);
      font-weight:800;
      font-size:12px;
      margin-bottom:8px;
    }
    .divider{
      display:flex;align-items:center;gap:10px;color:rgba(255,255,255,.45);
      font-size:12px;margin:8px 0 0;
    }
    .divider:before,.divider:after{
      content:"";height:1px;flex:1;background:rgba(255,255,255,.10);
    }

    @media (max-width: 960px){
      .split{grid-template-columns:1fr}
      .grid3{grid-template-columns:1fr}
      .loginShell{grid-template-columns:1fr}
      .tr{grid-template-columns: 1.1fr .9fr .9fr .6fr 56px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar" id="topbar">
      <div class="brand">
        <div class="logo">ADM</div>
        <div>
          <h1>Admin Alfa</h1>
          <p>Clientes ‚Ä¢ Categorias ‚Ä¢ Produtos</p>
        </div>
      </div>

      <div class="pillrow">
        <div class="pill">Status: <b id="uiStatus">Deslogado</b></div>
        <div class="pill">API: <b id="uiApi">‚Äî</b></div>
        <button class="btn danger" id="btnLogout" style="display:none">
          <span class="icon">‚éã</span> Sair
        </button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="loginShell" id="loginShell">
      <div class="loginCard">
        <div class="loginBox">
          <div class="stepTag" id="stepTag">Passo 1/2</div>
          <h2 class="loginTitle" id="stepTitle">Entre na sua conta</h2>
          <p class="loginSub" id="stepSub">Use email/senha (Supabase) ou Google.</p>

          <div id="stepEmail">
            <div class="field">
              <label>Email</label>
              <input id="email" type="email" placeholder="seuemail@exemplo.com" autocomplete="email" />
            </div>
            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnGoPass">Continuar</button>
              <button class="btn" id="btnGoogle1">Entrar com Google</button>
            </div>
          </div>

          <div id="stepPass" style="display:none">
            <div class="field">
              <label>Email</label>
              <input id="email2" type="email" disabled />
            </div>
            <div class="field" style="margin-top:10px">
              <label>Senha</label>
              <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
            </div>
            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnLogin">Entrar</button>
              <button class="btn" id="btnGoogle2">Entrar com Google</button>
              <button class="btn ghost" id="btnBack">Voltar</button>
            </div>
          </div>

          <div class="msg bad" id="loginErr" style="display:none"></div>
        </div>
      </div>

      <div class="loginCard">
        <div style="display:flex;flex-direction:column;gap:12px;padding:14px">
          <div class="badge" style="width:fit-content">Dica r√°pida</div>
          <div style="color:var(--muted);font-size:13px;line-height:1.5">
            ‚Ä¢ Se clicar e ‚Äún√£o acontecer nada‚Äù, normalmente √© <b>token</b> n√£o sendo enviado ou <b>CORS</b> no endpoint.<br/>
            ‚Ä¢ Este admin envia automaticamente o token do Supabase no header <b>Authorization</b>.<br/>
            ‚Ä¢ API Vercel configurada em: <b id="uiApi2">‚Äî</b>.
          </div>

          <div class="divider">Config</div>
          <div class="field">
            <label>URL da API (Vercel)</label>
            <input id="apiBaseInput" placeholder="https://seu-projeto.vercel.app" />
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn small" id="btnSaveApi">Salvar API</button>
            <button class="btn small" id="btnResetApi">Reset</button>
          </div>
          <div class="msg" style="margin:0">
            Padr√£o: <b>https://cafeteria-gamma-orpin.vercel.app</b>
          </div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="app" style="display:none">
      <div class="grid3">
        <div class="kpi blue">
          <div class="t"><span>Clientes</span><span class="chip">Total</span></div>
          <div class="v" id="kpiClientes">‚Äî</div>
        </div>
        <div class="kpi teal">
          <div class="t"><span>Categorias</span><span class="chip">Total</span></div>
          <div class="v" id="kpiCategorias">‚Äî</div>
        </div>
        <div class="kpi purple">
          <div class="t"><span>Produtos</span><span class="chip">Total</span></div>
          <div class="v" id="kpiProdutos">‚Äî</div>
        </div>
      </div>

      <div class="panel">
        <div class="tabs">
          <button class="tab active" data-tab="clientes">Clientes</button>
          <button class="tab" data-tab="categorias">Categorias</button>
          <button class="tab" data-tab="produtos">Produtos</button>
        </div>

        <div id="msgGlobal" class="msg" style="display:none"></div>

        <!-- CLIENTES -->
        <div class="split" id="tab-clientes">
          <div>
            <h2 style="margin:6px 0 6px">Cadastrar Cliente</h2>
            <div class="row">
              <div class="field">
                <label>Nome</label>
                <input id="cli_nome" placeholder="ex: Cuscuz da Baiana" />
              </div>
              <div class="field">
                <label>Slug</label>
                <input id="cli_slug" placeholder="ex: cuscuz-da-baiana" />
              </div>
              <div class="field">
                <label>WhatsApp</label>
                <input id="cli_whats" placeholder="ex: 62999999999" />
              </div>
              <div class="field">
                <label>Status</label>
                <select id="cli_ativo">
                  <option value="true">Ativo</option>
                  <option value="false">Inativo</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field">
                <label>Email do dono (opcional)</label>
                <input id="cli_owner_email" placeholder="ex: dono@loja.com" />
              </div>
              <div class="field">
                <label>Senha do dono (opcional)</label>
                <input id="cli_owner_pass" type="password" placeholder="defina uma senha" />
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <button class="btn primary" id="btnSalvarCliente">Salvar</button>
              <button class="btn" id="btnLimparCliente">Limpar</button>
              <span class="badge" id="cli_hint">Link: ?u=slug</span>
            </div>
          </div>

          <div>
            <div class="listhead">
              <div>
                <h2 style="margin:6px 0 2px">Clientes</h2>
                <div class="td muted">Lista em linha + menu ‚ãØ</div>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                <input id="cli_search" placeholder="Buscar..." style="min-width:240px" />
                <button class="btn small" id="btnReloadClientes">Recarregar</button>
              </div>
            </div>

            <div class="table" id="tblClientes">
              <div class="tr th">
                <div>Nome</div>
                <div>Slug</div>
                <div>WhatsApp</div>
                <div>Status</div>
                <div></div>
              </div>
              <!-- rows -->
            </div>
          </div>
        </div>

        <!-- CATEGORIAS -->
        <div class="split" id="tab-categorias" style="display:none">
          <div>
            <h2 style="margin:6px 0 6px">Cadastrar Categoria</h2>
            <div class="row">
              <div class="field">
                <label>Cliente</label>
                <select id="cat_cliente"></select>
              </div>
              <div class="field">
                <label>Nome</label>
                <input id="cat_nome" placeholder="ex: Bebidas" />
              </div>
              <div class="field">
                <label>Ordem</label>
                <input id="cat_ordem" type="number" placeholder="ex: 1" />
              </div>
              <div class="field">
                <label>Status</label>
                <select id="cat_ativo">
                  <option value="true">Ativa</option>
                  <option value="false">Inativa</option>
                </select>
              </div>
            </div>
            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnSalvarCategoria">Salvar</button>
              <button class="btn" id="btnLimparCategoria">Limpar</button>
            </div>
          </div>

          <div>
            <div class="listhead">
              <div>
                <h2 style="margin:6px 0 2px">Categorias</h2>
                <div class="td muted">Por cliente, com menu ‚ãØ</div>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                <input id="cat_search" placeholder="Buscar..." style="min-width:240px" />
                <button class="btn small" id="btnReloadCategorias">Recarregar</button>
              </div>
            </div>

            <div class="table" id="tblCategorias">
              <div class="tr th" style="grid-template-columns: 1fr .9fr .6fr .6fr 64px">
                <div>Nome</div>
                <div>Cliente</div>
                <div>Ordem</div>
                <div>Status</div>
                <div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- PRODUTOS -->
        <div class="split" id="tab-produtos" style="display:none">
          <div>
            <h2 style="margin:6px 0 6px">Cadastrar Produto</h2>
            <div class="row">
              <div class="field">
                <label>Cliente</label>
                <select id="pro_cliente"></select>
              </div>
              <div class="field">
                <label>Categoria</label>
                <select id="pro_categoria"></select>
              </div>
              <div class="field">
                <label>Nome</label>
                <input id="pro_nome" placeholder="ex: Cappuccino" />
              </div>
              <div class="field">
                <label>Pre√ßo</label>
                <input id="pro_preco" type="number" step="0.01" placeholder="ex: 12.50" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field" style="min-width:280px">
                <label>Descri√ß√£o</label>
                <textarea id="pro_desc" placeholder="opcional"></textarea>
              </div>
              <div class="field">
                <label>Imagem (URL)</label>
                <input id="pro_img" placeholder="https://..." />
              </div>
              <div class="field">
                <label>Status</label>
                <select id="pro_ativo">
                  <option value="true">Ativo</option>
                  <option value="false">Inativo</option>
                </select>
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnSalvarProduto">Salvar</button>
              <button class="btn" id="btnLimparProduto">Limpar</button>
            </div>
          </div>

          <div>
            <div class="listhead">
              <div>
                <h2 style="margin:6px 0 2px">Produtos</h2>
                <div class="td muted">Lista em linha + menu ‚ãØ</div>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                <input id="pro_search" placeholder="Buscar..." style="min-width:240px" />
                <button class="btn small" id="btnReloadProdutos">Recarregar</button>
              </div>
            </div>

            <div class="table" id="tblProdutos">
              <div class="tr th" style="grid-template-columns: 1.1fr .8fr .8fr .6fr 64px">
                <div>Nome</div>
                <div>Cliente</div>
                <div>Categoria</div>
                <div>Status</div>
                <div></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    /* =========================
      CONFIG
    ========================== */
    const SUPABASE_URL = "https://rgsnmxspyywwouhcdwkj.supabase.co";
    const SUPABASE_ANON = "sb_publishable_nHPsCV3y79FgexEMAeANWQ_P6jWRDd1";

    const DEFAULT_API_BASE = "https://cafeteria-gamma-orpin.vercel.app";
    const LS_API = "CARDAPIO_API_BASE";

    const apiBase = () => (localStorage.getItem(LS_API) || DEFAULT_API_BASE).replace(/\/+$/,"");

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    /* =========================
      UI helpers
    ========================== */
    const $ = (id) => document.getElementById(id);

    function setStatus(text){
      $("uiStatus").textContent = text;
    }
    function setApiUi(){
      const h = apiBase().replace(/^https?:\/\//,"");
      $("uiApi").textContent = h;
      $("uiApi2").textContent = apiBase();
      $("apiBaseInput").value = apiBase();
    }
    function showMsg(text, type=""){
      const el = $("msgGlobal");
      el.style.display = "block";
      el.className = "msg" + (type ? " "+type : "");
      el.textContent = text;
      setTimeout(()=>{ el.style.display="none"; }, 5000);
    }
    function showLoginErr(text){
      const el = $("loginErr");
      el.style.display = "block";
      el.textContent = text;
    }
    function clearLoginErr(){ $("loginErr").style.display="none"; $("loginErr").textContent=""; }

    function slugify(str){
      return (str||"")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9]+/g,"-")
        .replace(/(^-|-$)/g,"")
        .slice(0,80);
    }

    /* =========================
      Auth + API
    ========================== */
    async function getToken(){
      const { data } = await sb.auth.getSession();
      return data?.session?.access_token || null;
    }

    async function apiFetch(path, opts={}){
      const url = apiBase() + path;
      const token = await getToken();

      const headers = Object.assign(
        { "Content-Type":"application/json" },
        opts.headers || {}
      );

      if (token) headers["Authorization"] = "Bearer " + token;

      const res = await fetch(url, {
        method: opts.method || "GET",
        headers,
        body: opts.body ? JSON.stringify(opts.body) : undefined
      });

      let json = null;
      try { json = await res.json(); } catch(e){}

      if (!res.ok){
        const msg = (json && (json.error || json.message)) ? (json.error || json.message) : ("HTTP " + res.status);
        throw new Error(msg);
      }
      return json;
    }

    /* =========================
      Login flow (Email -> Senha + Google)
    ========================== */
    function goToPassStep(email){
      $("stepEmail").style.display = "none";
      $("stepPass").style.display = "block";
      $("stepTag").textContent = "Passo 2/2";
      $("email2").value = email || "";
      $("pass").focus();
    }
    function goToEmailStep(){
      $("stepPass").style.display = "none";
      $("stepEmail").style.display = "block";
      $("stepTag").textContent = "Passo 1/2";
      $("email").focus();
    }

    async function loginWithPassword(){
      clearLoginErr();
      const email = ($("email2").value || "").trim();
      const pass = $("pass").value || "";
      if (!email) return showLoginErr("Informe seu email.");
      if (!pass) return showLoginErr("Informe sua senha.");

      const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
      if (error) return showLoginErr(error.message || "Erro ao entrar.");
      if (!data?.session) return showLoginErr("Sess√£o n√£o criada.");
    }

    async function loginWithGoogle(){
      clearLoginErr();
      const redirectTo = window.location.origin + window.location.pathname; // volta pra /admin/
      const { error } = await sb.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo }
      });
      if (error) showLoginErr(error.message || "Erro no Google.");
    }

    async function logout(){
      await sb.auth.signOut();
    }

    /* =========================
      State + Data
    ========================== */
    let clientes = [];
    let categorias = [];
    let produtos = [];
    let editing = { clientes:null, categorias:null, produtos:null };

    function setTab(name){
      document.querySelectorAll(".tab").forEach(b=>{
        b.classList.toggle("active", b.dataset.tab === name);
      });
      ["clientes","categorias","produtos"].forEach(t=>{
        $("tab-"+t).style.display = (t===name) ? "grid" : "none";
      });
    }

    function closeAllMenus(){
      document.querySelectorAll(".menu").forEach(m=>m.classList.remove("open"));
    }
    document.addEventListener("click",(e)=>{
      if (!e.target.closest(".menuWrap")) closeAllMenus();
    });

    function menuHtml(items){
      // items: [{label, onClick, danger, hint}]
      return "";
    }

    function makeDotsMenu(actions){
      const wrap = document.createElement("div");
      wrap.className = "menuWrap";

      const btn = document.createElement("button");
      btn.className = "dots";
      btn.type = "button";
      btn.textContent = "‚ãØ";

      const menu = document.createElement("div");
      menu.className = "menu";

      actions.forEach(a=>{
        const mi = document.createElement("div");
        mi.className = "mi" + (a.danger ? " danger" : "");
        mi.innerHTML = `<span class="icon">${a.icon||"‚Ä¢"}</span><span>${a.label}</span>` + (a.hint ? `<span class="s">${a.hint}</span>` : "");
        mi.onclick = () => { menu.classList.remove("open"); a.onClick(); };
        menu.appendChild(mi);
      });

      btn.onclick = (ev) => {
        ev.stopPropagation();
        closeAllMenus();
        menu.classList.toggle("open");
      };

      wrap.appendChild(btn);
      wrap.appendChild(menu);
      return wrap;
    }

    function fmtWhats(w){ return (w||"").toString().replace(/[^\d]/g,""); }

    /* =========================
      Render
    ========================== */
    function renderKPIs(){
      $("kpiClientes").textContent = clientes.length;
      $("kpiCategorias").textContent = categorias.length;
      $("kpiProdutos").textContent = produtos.length;
    }

    function renderSelects(){
      const cliOpts = clientes
        .slice()
        .sort((a,b)=>(a.nome||"").localeCompare(b.nome||""))
        .map(c=>`<option value="${c.slug}">${c.nome} (${c.slug})</option>`)
        .join("");

      $("cat_cliente").innerHTML = `<option value="">Selecione...</option>` + cliOpts;
      $("pro_cliente").innerHTML = `<option value="">Selecione...</option>` + cliOpts;

      // categoria depende do cliente selecionado
      updateCategoriaSelectByCliente();
    }

    function updateCategoriaSelectByCliente(){
      const cli = $("pro_cliente").value;
      const cats = categorias
        .filter(c => (c.cliente_slug || c.cliente || c.clienteId || c.cliente_id) === cli || c.cliente_slug === cli || c.cliente === cli)
        .slice()
        .sort((a,b)=>(a.ordem||0)-(b.ordem||0));

      const opts = cats.map(c=>`<option value="${c.id}">${c.nome}</option>`).join("");
      $("pro_categoria").innerHTML = `<option value="">Selecione...</option>` + opts;
    }

    function renderClientes(){
      const q = ($("cli_search").value||"").toLowerCase().trim();
      const tbl = $("tblClientes");
      tbl.querySelectorAll(".tr.data").forEach(n=>n.remove());

      const rows = clientes.filter(c=>{
        if(!q) return true;
        return (c.nome||"").toLowerCase().includes(q) || (c.slug||"").toLowerCase().includes(q);
      });

      rows.forEach(c=>{
        const tr = document.createElement("div");
        tr.className = "tr data";

        const ativo = (c.ativo === true || c.ativo === "true");

        tr.innerHTML = `
          <div class="td">${c.nome || "-"}</div>
          <div class="td muted">${c.slug || "-"}</div>
          <div class="td muted">${fmtWhats(c.whatsapp || "") || "-"}</div>
          <div class="td">${ativo ? `<span class="badge ok">Ativo</span>` : `<span class="badge off">Inativo</span>`}</div>
          <div></div>
        `;

        const actions = makeDotsMenu([
          { icon:"üëÅ", label:"Ver publicado", onClick:()=> openPublic(c.slug), hint:"?u="+c.slug },
          { icon:"üîó", label:"Copiar link", onClick:()=> copyText(publicUrl(c.slug)) },
          { icon:"‚úèÔ∏è", label:"Editar", onClick:()=> loadClienteToForm(c) },
          { icon:"üìÑ", label:"Duplicar", onClick:()=> duplicateCliente(c) },
          { icon: ativo ? "‚õî" : "‚úÖ", label: ativo ? "Desativar" : "Ativar", onClick:()=> toggleCliente(c) },
          { icon:"üóë", label:"Excluir", danger:true, onClick:()=> deleteCliente(c) },
        ]);
        tr.lastElementChild.appendChild(actions);
        tbl.appendChild(tr);
      });
    }

    function renderCategorias(){
      const q = ($("cat_search").value||"").toLowerCase().trim();
      const tbl = $("tblCategorias");
      tbl.querySelectorAll(".tr.data").forEach(n=>n.remove());

      const cliBySlug = Object.fromEntries(clientes.map(c=>[c.slug, c]));

      const rows = categorias.filter(c=>{
        if(!q) return true;
        const cli = cliBySlug[c.cliente_slug]?.nome || c.cliente_slug || "";
        return (c.nome||"").toLowerCase().includes(q) || cli.toLowerCase().includes(q);
      });

      rows.forEach(cat=>{
        const tr = document.createElement("div");
        tr.className = "tr data";
        tr.style.gridTemplateColumns = "1fr .9fr .6fr .6fr 64px";

        const ativo = (cat.ativo === true || cat.ativo === "true");
        const cliName = (cliBySlug[cat.cliente_slug]?.nome) || cat.cliente_slug || "-";

        tr.innerHTML = `
          <div class="td">${cat.nome || "-"}</div>
          <div class="td muted">${cliName}</div>
          <div class="td muted">${cat.ordem ?? "-"}</div>
          <div class="td">${ativo ? `<span class="badge ok">Ativa</span>` : `<span class="badge off">Inativa</span>`}</div>
          <div></div>
        `;

        const actions = makeDotsMenu([
          { icon:"‚úèÔ∏è", label:"Editar", onClick:()=> loadCategoriaToForm(cat) },
          { icon:"üìÑ", label:"Duplicar", onClick:()=> duplicateCategoria(cat) },
          { icon: ativo ? "‚õî" : "‚úÖ", label: ativo ? "Desativar" : "Ativar", onClick:()=> toggleCategoria(cat) },
          { icon:"üóë", label:"Excluir", danger:true, onClick:()=> deleteCategoria(cat) },
        ]);
        tr.lastElementChild.appendChild(actions);
        tbl.appendChild(tr);
      });
    }

    function renderProdutos(){
      const q = ($("pro_search").value||"").toLowerCase().trim();
      const tbl = $("tblProdutos");
      tbl.querySelectorAll(".tr.data").forEach(n=>n.remove());

      const cliBySlug = Object.fromEntries(clientes.map(c=>[c.slug, c]));
      const catById = Object.fromEntries(categorias.map(c=>[c.id, c]));

      const rows = produtos.filter(p=>{
        if(!q) return true;
        const cli = cliBySlug[p.cliente_slug]?.nome || p.cliente_slug || "";
        const cat = catById[p.categoria_id]?.nome || "";
        return (p.nome||"").toLowerCase().includes(q) || cli.toLowerCase().includes(q) || cat.toLowerCase().includes(q);
      });

      rows.forEach(p=>{
        const tr = document.createElement("div");
        tr.className = "tr data";
        tr.style.gridTemplateColumns = "1.1fr .8fr .8fr .6fr 64px";

        const ativo = (p.ativo === true || p.ativo === "true");
        const cliName = cliBySlug[p.cliente_slug]?.nome || p.cliente_slug || "-";
        const catName = catById[p.categoria_id]?.nome || "-";

        tr.innerHTML = `
          <div class="td">${p.nome || "-"}</div>
          <div class="td muted">${cliName}</div>
          <div class="td muted">${catName}</div>
          <div class="td">${ativo ? `<span class="badge ok">Ativo</span>` : `<span class="badge off">Inativo</span>`}</div>
          <div></div>
        `;

        const actions = makeDotsMenu([
          { icon:"‚úèÔ∏è", label:"Editar", onClick:()=> loadProdutoToForm(p) },
          { icon:"üìÑ", label:"Duplicar", onClick:()=> duplicateProduto(p) },
          { icon: ativo ? "‚õî" : "‚úÖ", label: ativo ? "Desativar" : "Ativar", onClick:()=> toggleProduto(p) },
          { icon:"üóë", label:"Excluir", danger:true, onClick:()=> deleteProduto(p) },
        ]);
        tr.lastElementChild.appendChild(actions);
        tbl.appendChild(tr);
      });
    }

    function publicUrl(slug){
      // github pages /cafeteria/?u=slug
      const base = window.location.origin + "/cafeteria/";
      return base + "?u=" + encodeURIComponent(slug);
    }
    function openPublic(slug){
      window.open(publicUrl(slug), "_blank");
    }
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        showMsg("Link copiado ‚úÖ", "ok");
      }catch{
        prompt("Copie:", text);
      }
    }

    /* =========================
      CRUD calls (API Vercel)
      Ajuste se seus endpoints usarem nomes diferentes.
    ========================== */
    async function loadAll(){
      try{
        const [c1,c2,c3] = await Promise.all([
          apiFetch("/api/admin/clientes"),
          apiFetch("/api/admin/categorias"),
          apiFetch("/api/admin/produtos"),
        ]);
        clientes = c1.data || c1 || [];
        categorias = c2.data || c2 || [];
        produtos = c3.data || c3 || [];

        renderKPIs();
        renderSelects();
        renderClientes();
        renderCategorias();
        renderProdutos();
      }catch(e){
        showMsg("Falha ao carregar: " + e.message, "bad");
      }
    }

    async function saveCliente(){
      const nome = $("cli_nome").value.trim();
      const slug = slugify($("cli_slug").value.trim() || nome);
      const whatsapp = fmtWhats($("cli_whats").value);
      const ativo = $("cli_ativo").value === "true";

      const owner_email = $("cli_owner_email").value.trim();
      const owner_password = $("cli_owner_pass").value;

      if(!nome) return showMsg("Informe o nome do cliente.", "bad");
      if(!slug) return showMsg("Informe o slug.", "bad");

      const body = { nome, slug, whatsapp, ativo };
      if(owner_email && owner_password){
        body.owner_email = owner_email;
        body.owner_password = owner_password;
      }

      try{
        if(editing.clientes){
          await apiFetch("/api/admin/clientes", { method:"PATCH", body: { id: editing.clientes.id, ...body } });
          showMsg("Cliente atualizado ‚úÖ", "ok");
        }else{
          await apiFetch("/api/admin/clientes", { method:"POST", body });
          showMsg("Cliente criado ‚úÖ", "ok");
        }
        clearClienteForm();
        await loadAll();
      }catch(e){
        showMsg("Erro ao salvar cliente: " + e.message, "bad");
      }
    }

    function loadClienteToForm(c){
      editing.clientes = c;
      $("cli_nome").value = c.nome || "";
      $("cli_slug").value = c.slug || "";
      $("cli_whats").value = c.whatsapp || "";
      $("cli_ativo").value = (c.ativo === true || c.ativo === "true") ? "true" : "false";
      $("cli_owner_email").value = "";
      $("cli_owner_pass").value = "";
      $("cli_hint").textContent = "Editando: " + (c.slug || "");
      showMsg("Modo edi√ß√£o: Cliente", "ok");
    }
    function clearClienteForm(){
      editing.clientes = null;
      $("cli_nome").value = "";
      $("cli_slug").value = "";
      $("cli_whats").value = "";
      $("cli_ativo").value = "true";
      $("cli_owner_email").value = "";
      $("cli_owner_pass").value = "";
      $("cli_hint").textContent = "Link: ?u=slug";
    }
    async function toggleCliente(c){
      try{
        const ativo = !(c.ativo === true || c.ativo === "true");
        await apiFetch("/api/admin/clientes", { method:"PATCH", body:{ id:c.id, ativo } });
        await loadAll();
      }catch(e){ showMsg("Erro: "+e.message, "bad"); }
    }
    async function duplicateCliente(c){
      try{
        const baseSlug = (c.slug || "cliente") + "-copia";
        await apiFetch("/api/admin/clientes", { method:"POST", body:{
          nome: (c.nome||"Cliente")+" (c√≥pia)",
          slug: baseSlug,
          whatsapp: fmtWhats(c.whatsapp||""),
          ativo: false
        }});
        await loadAll();
        showMsg("Cliente duplicado ‚úÖ", "ok");
      }catch(e){ showMsg("Erro: "+e.message, "bad"); }
    }
    async function deleteCliente(c){
      if(!confirm("Excluir cliente '"+(c.nome||c.slug)+"'?")) return;
      try{
        await apiFetch("/api/admin/clientes", { method:"DELETE", body:{ id:c.id } });
        await loadAll();
        showMsg("Cliente exclu√≠do ‚úÖ", "ok");
      }catch(e){ showMsg("Erro: "+e.message, "bad"); }
    }

    async function saveCategoria(){
      const cliente_slug = $("cat_cliente").value;
      const nome = $("cat_nome").value.trim();
      const ordem = Number($("cat_ordem").value || 0);
      const ativo = $("cat_ativo").value === "true";
      if(!cliente_slug) return showMsg("Selecione um cliente.", "bad");
      if(!nome) return showMsg("Informe o nome da categoria.", "bad");

      const body = { cliente_slug, nome, ordem, ativo };

      try{
        if(editing.categorias){
          await apiFetch("/api/admin/categorias", { method:"PATCH", body:{ id: editing.categorias.id, ...body }});
          showMsg("Categoria atualizada ‚úÖ", "ok");
        }else{
          await apiFetch("/api/admin/categorias", { method:"POST", body });
          showMsg("Categoria criada ‚úÖ", "ok");
        }
        clearCategoriaForm();
        await loadAll();
      }catch(e){
        showMsg("Erro ao salvar categoria: " + e.message, "bad");
      }
    }
    function loadCategoriaToForm(c){
      editing.categorias = c;
      $("cat_cliente").value = c.cliente_slug || "";
      $("cat_nome").value = c.nome || "";
      $("cat_ordem").value = c.ordem ?? 0;
      $("cat_ativo").value = (c.ativo === true || c.ativo === "true") ? "true" : "false";
      showMsg("Modo edi√ß√£o: Categoria", "ok");
    }
    function clearCategoriaForm(){
      editing.categorias = null;
      $("cat_cliente").value = "";
      $("cat_nome").value = "";
      $("cat_ordem").value = "";
      $("cat_ativo").value = "true";
    }
    async function toggleCategoria(c){
      try{
        const ativo = !(c.ativo === true || c.ativo === "true");
        await apiFetch("/api/admin/categorias", { method:"PATCH", body:{ id:c.id, ativo } });
        await loadAll();
      }catch(e){ showMsg("Erro: "+e.message, "bad"); }
    }
    async function duplicateCategoria(c){
      try{
        await apiFetch("/api/admin/categorias", { method:"POST", body:{
          cliente_slug: c.cliente_slug,
          nome: (c.nome||"Categoria")+" (c√≥pia)",
          ordem: (c.ordem||0)+1,
          ativo: false
        }});
        await loadAll();
        showMsg("Categoria duplicada ‚úÖ", "ok");
      }catch(e){ showMsg("Erro: "+e.message, "bad"); }
    }
    async function deleteCategoria(c){
      if(!confirm("Excluir categoria '"+(c.nome||"")+"'?")) return;
      try{
        await apiFetch("/api/admin/categorias", { method:"DELETE", body:{ id:c.id } });
        await loadAll();
        showMsg("Categoria exclu√≠da ‚úÖ", "ok");
      }catch(e){ showMsg("Erro: "+e.message, "bad"); }
    }

    async function saveProduto(){
      const cliente_slug = $("pro_cliente").value;
      const categoria_id = $("pro_categoria").value ? Number($("pro_categoria").value) : null;
      const nome = $("pro_nome").value.trim();
      const preco = Number($("pro_preco").value || 0);
      const descricao = $("pro_desc").value.trim();
      const imagem = $("pro_img").value.trim();
      const ativo = $("pro_ativo").value === "true";

      if(!cliente_slug) return showMsg("Selecione um cliente.", "bad");
      if(!categoria_id) return showMsg("Selecione uma categoria.", "bad");
      if(!nome) return showMsg("Informe o nome do produto.", "bad");

      const body = { cliente_slug, categoria_id, nome, preco, descricao, imagem, ativo };

      try{
        if(editing.produtos){
          await apiFetch("/api/admin/produtos", { method:"PATCH", body:{ id: editing.produtos.id, ...body }});
          showMsg("Produto atualizado ‚úÖ", "ok");
        }else{
          await apiFetch("/api/admin/produtos", { method:"POST", body });
          showMsg("Produto criado ‚úÖ", "ok");
        }
        clearProdutoForm();
        await loadAll();
      }catch(e){
        showMsg("Erro ao salvar produto: " + e.message, "bad");
      }
    }
    function loadProdutoToForm(p){
      editing.produtos = p;
      $("pro_cliente").value = p.cliente_slug || "";
      updateCategoriaSelectByCliente();
      $("pro_categoria").value = p.categoria_id ?? "";
      $("pro_nome").value = p.nome || "";
      $("pro_preco").value = p.preco ?? "";
      $("pro_desc").value = p.descricao || "";
      $("pro_img").value = p.imagem || "";
      $("pro_ativo").value = (p.ativo === true || p.ativo === "true") ? "true" : "false";
      showMsg("Modo edi√ß√£o: Produto", "ok");
    }
    function clearProdutoForm(){
      editing.produtos = null;
      $("pro_cliente").value = "";
      updateCategoriaSelectByCliente();
      $("pro_categoria").value = "";
      $("pro_nome").value = "";
      $("pro_preco").value = "";
      $("pro_desc").value = "";
      $("pro_img").value = "";
      $("pro_ativo").value = "true";
    }
    async function toggleProduto(p){
      try{
        const ativo = !(p.ativo === true || p.ativo === "true");
        await apiFetch("/api/admin/produtos", { method:"PATCH", body:{ id:p.id, ativo } });
        await loadAll();
      }catch(e){ showMsg("Erro: "+e.message, "bad"); }
    }
    async function duplicateProduto(p){
      try{
        await apiFetch("/api/admin/produtos", { method:"POST", body:{
          cliente_slug: p.cliente_slug,
          categoria_id: p.categoria_id,
          nome: (p.nome||"Produto")+" (c√≥pia)",
          preco: p.preco ?? 0,
          descricao: p.descricao || "",
          imagem: p.imagem || "",
          ativo: false
        }});
        await loadAll();
        showMsg("Produto duplicado ‚úÖ", "ok");
      }catch(e){ showMsg("Erro: "+e.message, "bad"); }
    }
    async function deleteProduto(p){
      if(!confirm("Excluir produto '"+(p.nome||"")+"'?")) return;
      try{
        await apiFetch("/api/admin/produtos", { method:"DELETE", body:{ id:p.id } });
        await loadAll();
        showMsg("Produto exclu√≠do ‚úÖ", "ok");
      }catch(e){ showMsg("Erro: "+e.message, "bad"); }
    }

    /* =========================
      Boot
    ========================== */
    function setLoggedUI(session){
      const logged = !!session;
      $("loginShell").style.display = logged ? "none" : "grid";
      $("app").style.display = logged ? "block" : "none";
      $("btnLogout").style.display = logged ? "inline-flex" : "none";
      setStatus(logged ? "Logado" : "Deslogado");
      if(logged) loadAll();
    }

    // events
    $("btnGoPass").onclick = () => {
      clearLoginErr();
      const email = ($("email").value || "").trim();
      if(!email) return showLoginErr("Digite seu email.");
      goToPassStep(email);
    };
    $("btnBack").onclick = () => { clearLoginErr(); goToEmailStep(); };

    $("btnLogin").onclick = loginWithPassword;
    $("btnGoogle1").onclick = loginWithGoogle;
    $("btnGoogle2").onclick = loginWithGoogle;

    $("btnLogout").onclick = logout;

    $("btnSaveApi").onclick = () => {
      const v = ($("apiBaseInput").value || "").trim().replace(/\/+$/,"");
      if(!/^https?:\/\//i.test(v)) return showLoginErr("API inv√°lida. Use https://...");
      localStorage.setItem(LS_API, v);
      setApiUi();
      showMsg("API salva ‚úÖ", "ok");
    };
    $("btnResetApi").onclick = () => {
      localStorage.removeItem(LS_API);
      setApiUi();
      showMsg("API resetada ‚úÖ", "ok");
    };

    // tabs
    document.querySelectorAll(".tab").forEach(b=>{
      b.onclick = () => setTab(b.dataset.tab);
    });

    // auto-slug
    $("cli_nome").addEventListener("input", ()=>{
      if($("cli_slug").value.trim()) return;
      $("cli_slug").value = slugify($("cli_nome").value);
    });

    // selects
    $("pro_cliente").addEventListener("change", updateCategoriaSelectByCliente);

    // save buttons
    $("btnSalvarCliente").onclick = saveCliente;
    $("btnLimparCliente").onclick = () => { clearClienteForm(); showMsg("Form limpo", ""); };

    $("btnSalvarCategoria").onclick = saveCategoria;
    $("btnLimparCategoria").onclick = () => { clearCategoriaForm(); showMsg("Form limpo", ""); };

    $("btnSalvarProduto").onclick = saveProduto;
    $("btnLimparProduto").onclick = () => { clearProdutoForm(); showMsg("Form limpo", ""); };

    // reload
    $("btnReloadClientes").onclick = loadAll;
    $("btnReloadCategorias").onclick = loadAll;
    $("btnReloadProdutos").onclick = loadAll;

    // search render
    $("cli_search").addEventListener("input", renderClientes);
    $("cat_search").addEventListener("input", renderCategorias);
    $("pro_search").addEventListener("input", renderProdutos);

    // init
    (async function init(){
      setApiUi();

      // Captura sess√£o ao abrir (inclui retorno do Google)
      const { data } = await sb.auth.getSession();
      setLoggedUI(data?.session);

      sb.auth.onAuthStateChange(async (_event, session) => {
        setLoggedUI(session);
      });
    })();
  </script>
</body>
</html>
